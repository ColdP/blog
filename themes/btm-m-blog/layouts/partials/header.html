<div class="container header-content">
  <h1 class="site-title">{{ site.Title }}</h1>

  <div class="header-actions header-actions-desktop">
    {{ partial "menu.html" (dict "menuID" "main" "page" .) }}
    <div class="search-field">
      <span class="material-symbols-rounded">search</span>
      <input type="search" placeholder="Search" aria-label="Search" data-search-input>
    </div>
    <button id="theme-toggle" class="icon-button" aria-label="Toggle theme" title="Toggle theme">
      <span id="theme-icon" class="material-symbols-rounded">light_mode</span>
    </button>
  </div>

  <button id="mobile-menu-toggle" class="icon-button mobile-menu-toggle" aria-label="Open menu" title="Open menu">
    <span class="material-symbols-rounded">menu</span>
  </button>
</div>

<div id="mobile-menu-overlay" class="mobile-menu-overlay" hidden>
  <div class="container mobile-menu-panel">
    <div class="mobile-menu-top">
      <h2>Menu</h2>
      <button id="mobile-menu-close" class="icon-button" aria-label="Close menu" title="Close menu">
        <span class="material-symbols-rounded">close</span>
      </button>
    </div>
    <div class="search-field search-field-mobile">
      <span class="material-symbols-rounded">search</span>
      <input type="search" placeholder="Search" aria-label="Search" data-search-input>
    </div>
    <div class="mobile-nav">
      {{ partial "menu.html" (dict "menuID" "main" "page" .) }}
    </div>
    <button id="mobile-theme-toggle" class="mobile-theme-toggle" aria-label="Toggle theme">
      <span id="mobile-theme-icon" class="material-symbols-rounded">light_mode</span>
      <span id="mobile-theme-label">Light Mode</span>
    </button>
  </div>
</div>

<script>
  (function() {
    const html = document.documentElement;
    const themeToggle = document.getElementById('theme-toggle');
    const mobileThemeToggle = document.getElementById('mobile-theme-toggle');
    const themeIcon = document.getElementById('theme-icon');
    const mobileThemeIcon = document.getElementById('mobile-theme-icon');
    const mobileThemeLabel = document.getElementById('mobile-theme-label');
    const mobileMenuToggle = document.getElementById('mobile-menu-toggle');
    const mobileMenuClose = document.getElementById('mobile-menu-close');
    const mobileMenuOverlay = document.getElementById('mobile-menu-overlay');

    function getCurrentTheme() {
      return html.getAttribute('data-theme') || 'light';
    }

    function applyTheme(theme, persist) {
      html.setAttribute('data-theme', theme);
      if (persist) {
        localStorage.setItem('theme', theme);
      }
      const iconName = theme === 'dark' ? 'dark_mode' : 'light_mode';
      if (themeIcon) themeIcon.textContent = iconName;
      if (mobileThemeIcon) mobileThemeIcon.textContent = iconName;
      if (mobileThemeLabel) mobileThemeLabel.textContent = theme === 'dark' ? 'Dark Mode' : 'Light Mode';
    }

    function toggleTheme() {
      const newTheme = getCurrentTheme() === 'dark' ? 'light' : 'dark';
      applyTheme(newTheme, true);
    }

    function openMobileMenu() {
      if (!mobileMenuOverlay) return;
      mobileMenuOverlay.hidden = false;
      requestAnimationFrame(function() {
        mobileMenuOverlay.classList.add('is-open');
      });
      document.body.classList.add('menu-open');
    }

    function closeMobileMenu() {
      if (!mobileMenuOverlay) return;
      mobileMenuOverlay.classList.remove('is-open');
      window.setTimeout(function() {
        mobileMenuOverlay.hidden = true;
      }, 380);
      document.body.classList.remove('menu-open');
    }

    themeToggle && themeToggle.addEventListener('click', toggleTheme);
    mobileThemeToggle && mobileThemeToggle.addEventListener('click', toggleTheme);
    mobileMenuToggle && mobileMenuToggle.addEventListener('click', openMobileMenu);
    mobileMenuClose && mobileMenuClose.addEventListener('click', closeMobileMenu);
    mobileMenuOverlay && mobileMenuOverlay.addEventListener('click', function(event) {
      if (event.target === mobileMenuOverlay) {
        closeMobileMenu();
      }
    });

    document.addEventListener('keydown', function(event) {
      if (event.key === 'Escape' && mobileMenuOverlay && !mobileMenuOverlay.hidden) {
        closeMobileMenu();
      }
    });

    const mobileLinks = document.querySelectorAll('.mobile-nav a');
    mobileLinks.forEach(function(link) {
      link.addEventListener('click', closeMobileMenu);
    });

    applyTheme(getCurrentTheme(), false);

    const media = window.matchMedia('(prefers-color-scheme: dark)');
    media.addEventListener('change', function(e) {
      if (!localStorage.getItem('theme')) {
        applyTheme(e.matches ? 'dark' : 'light', false);
      }
    });
  })();
</script>
